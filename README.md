# Корпоративная система GitLab


## Загрузка проекта

Для загрузки проекта необходимо иметь типовую конфигурацию 1С:Управление небольшой фирмой.
Для непосредственной работы с доработками необходимо:
- Загрузить файлы src в расширение конфигурации
- Для включения работы RLS необходимо завести на каждого пользователя свою группу доступа и добавить его в нее и включить иерархию
- Для работы уведомлений необходимо добавить внешнее рег. задание с вызовом процедур отправки уведомлений. см. Настройка уведомлений
- Для работы с мобильным приложением необходимо установить мобильную платформу на устройство и установить IP адрес устройства.

## Синхронизация с GIT

Для синхронизации с GIT необходимо установить пакетный менеджер **OneScript** - opm, и плагин GitSync

### Инициализация GitSync репозитория

Для инициализации репозитория необходимо исполнить команду в PowerShell или другом терминале

```
gitsync init -u [Пользователь хранилища] -p [Пароль пользователя] -e [Имя расширения] [Адрес хранилища] [Адрес папки src]
```
После в указаной папке будут созданы файлы VERSION и AUTHORS, которые необходимо скорректировать с соответствующими параметрами

### Синхронизация GitSync с удаленным репозиторием

Для синхронизации необходимо исполнить следующую команду в PowerShell или другом терминале

```
gitsync sync -u [Пользователь хранилища] -p [Пароль пользователя] -e [Имя расширения] -pull (*При наличии плагина отправки) [Адрес хранилища] [Адрес папки src]
```
***При наличии плагина отправки***
Необходимо добавить флаг -pull или -push, в зависимости от необходимых действий

Если отправка проиходит вручную, то необходимо в конфиге указать user.email и user.name с флагом --global
и произвести действия отправки в GIT репозиторий

# Архитектура проекта

## Общая структура проекта

### Модификация форм

**Любая** модификация форм в проекте происходит программно в общем модуле Пр_МодификацияФормСервер.
Для вызова общего модуля с модификацией необходимо дополнить процедуру общего модуля **ПриСозданииНаСервере** и передать туда параметры:

* ЭтотОбъект - ФормаКлиентскогоПриложения
* СтандартнаяОбработка - Булево - Обработка создания формы
* Отказ - Булево - Отказ от открытия формы

После необходимо описать в отдельной процедуре с наименованием [МетаданныеРодитель][ИмяОбъекта]Форма[ТипФормы] и вызвать исполнение в процедуре **ПриСозданииНаСервере**

### Новые объекты и модификация типовых

Все **созданные** объекты созданы в расширении и имеют префиксацию **Пр_**. Все добавленные объекты выведены в подситему **Пр_КорпоративнаяСистемаGitLab**.
Все **модифицируемые** процедуры и функции из основной конфигурации имеют аннотацию **Перед**, **После**, **ИзменениеИКонтроль**.

## Добавление ВИП-лимитов и изменение структуры документа ЗаданиеНаРаботу

### Добавленные объекты:

Были добавлены следующие реквизиты для соответствия **Issue GitLab** и документа **ЗаданиеНаРаботу**.
Также были добавлены общие объекты для реализации **Аналитики** по заданиям, а также их **печтаные формы**

Добавленные объекты:
* Документ.ЗаданиеНаРаботу.Пр_Проект **Соответствие Issue**
* Документ.ЗаданиеНаРаботу.Пр_Идентификатор **Соответствие Issue**
* Документ.ЗаданиеНаРаботу.Пр_ОценкаВGitLab **Соответствие Issue**
* Документ.ЗаданиеНаРаботу.ФактВGitLab **Соответствие Issue**
* Документ.ЗаданиеНаРаботу.Макеты.Пр_ПФ_DOCX_ТехническоеЗадание **Печатная Форма**
* РегистрСведений.Пр_ЛимитыПоКолонкам **ВИП-Лимиты**
..* Измерения:
....* Календарь (СправочникСсылка.КалендариСотрудников)
....* Колонка (СправочникСсылка.КолонкиКалендарейСотрудников)
..* Ресурсы:
....* Лимит (Число)
* РегистрСведений.Пр_ПланФактовоеОтклонение **Аналитика**
..* Измерения:
....* Контрагент (СправочникСсылка.Контрагенты)
....* Проект (СправочникСсылка.Проекты)
....* ЗаданиеНаРаботу (ДокументСсылка.ЗаданиеНаРаботу)
....* Разработчик (СправочникСсылка.Сотрудники)
..* Ресурсы:
....* ПлановыеЗатраты (Число)
....* ФактическиеЗатраты (Число)
....* Разница (Число)

- Отчет.Пр_ПланФактовоеОтклонениеЗаданий **Аналитика**


### Описание ключевых механизмов

#### ЗаданиеНаРаботу

Для реализации модификации формы документа **ЗаданиеНаРаботу** в событии **ПриСозданииНаСервере** модуля формы документа был произведен вызов общего модуля **Пр_МодификацияФормСервер**, в котором были выведены на форму реквизиты объекта документа, а также привязаны обработчики событий элементов формы.

Для реализации корректного отображения статуса было принято не хранить в объекте данные о нем, а вывести реквизит формы, который будет обновлятся в двух обработчиках событий формы:
* ПриСозданииНаСервере
* ПриЧтенииНаСервере

В этих обработчиках вызывается процедура модуля формы документа **ПрочитатьСтатусЗадания(ЗаданиеНаРаботу)**. Данная процедура является оберткой для установки статуса. Сам статус вызвает функцию серверного общего модуля **Пр_КорпоративнаяСистемаGitLabВстраиваниеУНФСервер.СтатусЗаданияНаРаботу(ЗаданиеНаРаботу)**, в которой описывается непосредственно сам запрос к справочнику **ЗаписиКалендаряСотрудника**, который является карточкой задания в **Обработка.КонтактЦентр**. В случае если задание не имеет никакого статуса или его не сущестует пока что в **КонтактЦентр**, тогда происходит возвращение статуса по умолчанию - Необработанное.

Для создания динамически досок по проектам в обработке выбора реквизита **Пр_Проект** производится вызов функции серверного общего модуля **Пр_КорпоративнаяСистемаGitLabВстраиваниеУНФСервер.КалендарьСотрудникаПоПроекту(Проект)**, которая возвращает в случае нахождения существующий календарь или в случае если его нет - создает. При создании календаря формируется автоматически ВИП-лимит на колонку **Анализ** равный **4**.

Календарь сотрудника создается со следующим набором колонок:
* Необработанное (По умолчанию)
* Анализ
* В работе
* На проверке
* Готово
 
Для реализации печатных форм были загружены **ДвочиныеДанные** шаблона DOCX документа в макеты ЗаданиеНаРаботу. При формировании макета используется механизм БСП **УправлениеПечатью**

Для оформления аналитики в **обработке проведения** документа **задание на работу** создается запись в регистре свдеений **Пр_ПланФактовоеОтклонение**.

#### КонтактЦентр

Для реализации контроля **ВИП-лимитов** необходимо выделить следующие обработчики:
* ПереключательПриИзменении (Нажатие на левой верхней панели)
* ПодключаемыеПеретаскивание (Перетаскивание карточек между стадиями)
* Подключаемый_ЗаголовокДоскиНажатие (Выбор в разделе досок)

Данные обработчики влияют на **обновление** формы контакт центра.

Для обновления колонок в форме модуля обработки **КонтактЦентр** происходит вызов процедуры **ОбновитьЛимитыКолонокКалендаря**, где происходит сопоставления текущего количества записей по колонкам из справочника **ЗаписиКаледнаряСотрудника**, а также сопоставление с регистром сведений **Пр_ЛимитыПоКолонкам**. После получения необходимых значений в элементе **ДекорацияЗаголовокЗадачи_ИндексКолонки** происходит установка значений по колонкам. Индекс колонки - минус **1** от порядкового номера колонки в **Справочник.КолонкиКалендарейСотрудников**. Данный элемент создается **динамически**, в зависимости от колонок **текущей (выбранной)** доски.